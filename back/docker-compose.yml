
services:
  postgres-db:
    image: postgres:15-alpine
    container_name: ${POSTGRES_NAME}
    restart: ${RESTART_POSTGRES_STATE}
    environment:
      - POSTGRES_DB=${POSTGRES_DATABASE}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - ${POSTGRES_PORT}:5432
  mongo-db:
    image: mongo
    container_name: ${MONGO_NAME}
    restart: ${RESTART_MONGO_STATE}
    ports:
      - ${MONGO_PORT}:27017
    volumes:
      - mongo-data:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}

  file-server:
    image: nginx:alpine
    container_name: ${FILE_SERVER_NAME}
    restart: ${RESTART_FILE_SERVER_STATE}
    volumes:
      - poster-data:/usr/share/nginx/html/posters:ro
    ports:
      - ${FILE_SERVER_PORT}:80

  backend:
    build: .
    container_name: ${BACKEND_NAME:-movie-backend}
    restart: unless-stopped
    env_file: .env
    environment:
      POSTER_STORAGE_PATH: /app/storage/posters
      POSTGRES_HOST: postgres-db
      MONGO_HOST: mongo-db
    depends_on:
      - postgres-db
      - mongo-db
    volumes:
      - poster-data:/app/storage/posters
    ports:
      - ${BACKEND_PORT:-8080}:8080

volumes:
  postgres-data:
  mongo-data:
  poster-data:
